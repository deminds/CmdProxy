[general]
static=yes
writeprotect=yes

[globals]
CONFMAN_HOST=http://192.168.8.247:5000
CALL_DURATION=40

[default]
exten => _X.,1,Hungup

[default_def]
exten => _X.,1,Hungup

; =====
; FROM-xxx
; =====
;
[from_E1]
exten => _4051XX,1,NoOp(===== from E1 ${CALLERID(num)} to ${EXTEN}  =====)
same => n,NoOp(===== from E1 Change CALLERID =====)
same => n,Set(CALLERID(num)=${IF($["${CALLERID(num):0:4}"="4912"]?${CALLERID(num):4}:8${CALLERID(num)})})
same => n,Set(BACKGROUND_FILE=roek_${DB(DID_E1_BACKGROUND/${EXTEN})})
same => n,Set(EXIST_BACKGROUND_FILE=${STAT(e,/var/lib/asterisk/roek_sounds/${BACKGROUND_FILE}.alaw)})
same => n,Answer()
same => n,GotoIf($["${EXIST_BACKGROUND_FILE}"="1"]?background)

same => n(action_check),Set(ACTION=${DB(DID_E1_ACTION/${EXTEN})})
same => n,GotoIf($["${ACTION}"="DIAL"]?dial:)
same => n,GotoIf($["${ACTION}"="QUEUE"]?queue:)
same => n,Hangup()

same => n(background),Background(/var/lib/asterisk/roek_sounds/${BACKGROUND_FILE})
same => n,WaitExten(4)
same => n,Goto(action_check)

same => n(dial),NoOp(===== from E1 DIAL action =====)
same => n,Set(DID_NUM=${DB(DID_E1_NUM/${EXTEN})})
same => n,GoSub(blacklist,${EXTEN},1(${DID_NUM}))
same => n,Macro(record,${DID_NUM})
same => n,GoSub(call_forward,${DID_NUM},1)
same => n,Set(GROUP=${DB(DID_E1_GROUP/${EXTEN})})
same => n,GotoIf($["${GROUP}"!=""]?redir_queue:no_redir_queue)

same => n(redir_queue),NoOp(===== from E1 Redir_Queue action =====)
;same => n,Dial(SIP/${DID_NUM},7,t)
same => n,GoSub(to-office,${DID_NUM},1(7,t))
same => n,GoSub(to-sasovo,${DID_NUM},1(7,t))
same => n,GoSub(to-kasimov,${DID_NUM},1(7,t))
same => n,GoSub(to-mikhailov,${DID_NUM},1(7,t))
same => n,Queue(${GROUP},mt,,300)
same => n,Hangup()

same => n(no_redir_queue),NoOp(===== from E1 No_Redir_Queue action =====)
same => n,GoSub(call_forward,${DID_NUM},1)
same => n,GoSub(to-office,${DID_NUM},1(${CALL_DURATION},t))
same => n,GoSub(to-sasovo,${DID_NUM},1(${CALL_DURATION},t))
same => n,GoSub(to-kasimov,${DID_NUM},1(${CALL_DURATION},t))
same => n,GoSub(to-mikhailov,${DID_NUM},1(${CALL_DURATION},t))
;exten => _4051XX,n,Dial(SIP/${DID_NUM},40,t)
same => n,Hangup()

same => n(queue),NoOp(===== from E1 Queue action =====)
same => n,Set(DID_NUM=${DB(DID_E1_NUM/${EXTEN})})
same => n,GoSub(blacklist,${EXTEN},1(${DID_NUM}))
same => n,Macro(record,${DID_NUM})
same => n,Queue(${DID_NUM},mt,,300)
same => n,Hangup()

exten => _[53]XXX,1,NoOp(===== DISA to INTERNAL CALL from ${CALLERID(num)} to ${EXTEN} =====)
same => n,GoSub(blacklist,${EXTEN},1(${EXTEN}))
same => n,GoSub(to-office,${EXTEN},1(${CALL_DURATION},t))
same => n,GoSub(to-sasovo,${EXTEN},1(${CALL_DURATION},t))
same => n,GoSub(to-kasimov,${EXTEN},1(${CALL_DURATION},t))
same => n,GoSub(to-mikhailov,${EXTEN},1(${CALL_DURATION},t))
same => n,Hangup()

[from_roek_office]
exten => _*X.,1,GoSub(star_codes,${EXTEN},1)
same => n,Hangup()

exten => _X.,1,NoOp(===== FROM OFFICE ${CALLERID(num)} to ${EXTEN} =====)
same => n,GoSub(to-fax,${EXTEN},1(${BLINDTRANSFER:4:4}))
same => n,GoSub(to-office,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-sasovo,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-kasimov,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-mikhailov,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-emergency,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-city,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-mg,${EXTEN},1(${CALL_DURATION},T))
same => n,GoSub(to-mn,${EXTEN},1(${CALL_DURATION},T))

[from-sasovo]
exten => _X.,1,NoOp(===== FROM Sasovo ${CALLERID(num)} to ${EXTEN} =====)
same => n,GoSub(to-office,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-kasimov,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-mikhailov,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-city,${EXTEN},1(${CALL_DURATION},T))
same => n,GoSub(to-mg,${EXTEN},1(${CALL_DURATION},T))
same => n,Hangup()

[from-kasimov]
exten => _X.,1,NoOp(===== FROM Kasimov ${CALLERID(num)} to ${EXTEN} =====)
same => n,GoSub(to-office,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-sasovo,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-mikhailov,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-city,${EXTEN},1(${CALL_DURATION},T))
same => n,GoSub(to-mg,${EXTEN},1(${CALL_DURATION},T))
same => n,Hangup()

[from-mikhailov]
exten => _X.,1,NoOp(===== FROM Mikhailov ${CALLERID(num)} to ${EXTEN} =====)
same => n,GoSub(to-office,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-sasovo,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-kasimov,${EXTEN},1(${CALL_DURATION},tT))
same => n,GoSub(to-city,${EXTEN},1(${CALL_DURATION},T))
same => n,GoSub(to-mg,${EXTEN},1(${CALL_DURATION},T))
same => n,Hangup()

; =====
; TO-xxx
; =====
;
[to-fax]
exten => _X.,1,Return()

exten => _5555,1,NoOp(===== Transfer to Receive FAX from ${ARG1} =====)
exten => _5555,n,Set(FAX_SIP_NUM=${ARG1})
exten => _5555,n,GoSub(fax-rx,${EXTEN},1)

exten => _44XX,1, NoOp(===== Transfer to Send FAX ${ARG1} =====)
exten => _44XX,n,Set(FAX_SIP_NUM=${ARG1})
exten => _44XX,n,GoSub(fax-tx,${EXTEN},1)

[to-emergency]
; ${ARG1} - CALL_DURATION  
exten => _X.,1,Return()

exten => _0X,1,NoOp(===== to EMERGENCY CALL from ${CALLERID(num)} to ${EXTEN} =====)
same => n,Macro(record,${CALLERID(num)})
same => n,Set(CALLERID(num)=${IF($["${DB(DOD_E1/${CALLERID(num)})}"=""]?${DB(DOD_E1/global)}:${DB(DOD_E1/${CALLERID(num)})})})
same => n,Dial(DAHDI/g1/${EXTEN},${ARG1},T)
same => n,Hangup()

[to-office]
; ${ARG1} - CALL_DURATION  
; ${ARG2} - TRANSFER TYPE
; ${ARG3} - IN FORWARD EXECUTE
exten => _X.,1,Return()

exten => _5XXX,1,NoOp(===== to OFFICE CALL from ${CALLERID(num)} to ${EXTEN} =====)
same => n,Set(DB(REDIAL/${CALLERID(num)})=${EXTEN})
same => n,Macro(record,${CALLERID(num)})
same => n,Macro(record,${EXTEN})
same => n,GotoIf($["${ARG3}"="INFORWARD"]?no_forward:forward)

same => n(forward),GoSub(call_forward,${EXTEN},1)
same => n,Dial(SIP/${EXTEN},${ARG1},${ARG2})
same => n,Return()

same => n(no_forward),Dial(SIP/${EXTEN},${ARG1},${ARG2})
same => n,Return()

[to-city]
; ${ARG1} - CALL_DURATION  
; ${ARG2} - TRANSFER TYPE
exten => _X.,1,Return()

exten => _XXXXXX,1,NoOp(===== to CITY CALL from ${CALLERID(num)} to ${EXTEN} =====)
same => n,Set(DB(REDIAL/${CALLERID(num)})=${EXTEN})
same => n,Macro(record,${CALLERID(num)})
same => n,Set(CALLERID(num)=${IF($["${DB(DOD_E1/${CALLERID(num)})}"=""]?${DB(DOD_E1/global)}:${DB(DOD_E1/${CALLERID(num)})})})
same => n,Dial(DAHDI/g1/${EXTEN},${ARG1},${ARG2})
same => n,Hangup()

exten => _84912XXXXXX,1,NoOp(===== to CITY CALL from ${CALLERID(num)} to ${EXTEN} =====)
same => n,Set(DB(REDIAL/${CALLERID(num)})=${EXTEN})
same => n,Macro(record,${CALLERID(num)})
same => n,Set(CALLERID(num)=${IF($["${DB(DOD_E1/${CALLERID(num)})}"=""]?${DB(DOD_E1/global)}:${DB(DOD_E1/${CALLERID(num)})})})
same => n,Dial(DAHDI/g1/${EXTEN},${ARG1},${ARG2})
same => n,Hangup()

[to-mg]
; ${ARG1} - CALL_DURATION  
; ${ARG2} - TRANSFER TYPE
exten => _X.,1,Return()

exten => _8XXXXXXXXXX,1,NoOp(===== to MG CALL from ${CALLERID(num)} to ${EXTEN} =====)
same => n,Set(DB(REDIAL/${CALLERID(num)})=${EXTEN})
same => n,Macro(record,${CALLERID(num)})
same => n,Set(CALLERID(num)=${IF($["${DB(DOD_E1/${CALLERID(num)})}"=""]?${DB(DOD_E1/global)}:${DB(DOD_E1/${CALLERID(num)})})})
same => n,Dial(DAHDI/g1/${EXTEN},${ARG1},${ARG2})
same => n,Hangup()

[to-mn]
; ${ARG1} - CALL_DURATION  
exten => _X.,1,Return()

exten => _810X!,1,NoOp(===== to MN CALL from ${CALLERID(num)} to ${EXTEN} =====)
same => n,Macro(record,${CALLERID(num)})
same => n,Set(CALLERID(num)=${IF($["${DB(DOD_E1/${CALLERID(num)})}"=""]?${DB(DOD_E1/global)}:${DB(DOD_E1/${CALLERID(num)})})})
same => n,Dial(DAHDI/g1/${EXTEN},${ARG1},T)
same => n,Hangup()

[to-sasovo]
; ${ARG1} - CALL_DURATION  
; ${ARG2} - TRANSFER TYPE
exten => _X.,1,Return()

exten => _30XX,1,NoOp(===== to INTERNAL Sasovo CALL from ${CALLERID(num)} to ${EXTEN} =====)
same => n,Set(DB(REDIAL/${CALLERID(num)})=${EXTEN})
same => n,Macro(record,${CALLERID(num)})
same => n,Dial(IAX2/sasovo/${EXTEN},${ARG1},${ARG2})
same => n,Return()

[to-kasimov]
; ${ARG1} - CALL_DURATION  
; ${ARG2} - TRANSFER TYPE
exten => _X.,1,Return()

exten => _32XX,1,NoOp(===== to INTERNAL Kasimov CALL from ${CALLERID(num)} to ${EXTEN} =====)
same => n,Set(DB(REDIAL/${CALLERID(num)})=${EXTEN})
same => n,Macro(record,${CALLERID(num)})
same => n,Dial(IAX2/kasimov/${EXTEN},${ARG1},${ARG2})
same => n,Return()

[to-mikhailov]
; ${ARG1} - CALL_DURATION  
; ${ARG2} - TRANSFER TYPE
exten => _X.,1,Return()

exten => _31XX,1,NoOp(===== to INTERNAL Mikhailov CALL from ${CALLERID(num)} to ${EXTEN} =====)
same => n,Set(DB(REDIAL/${CALLERID(num)})=${EXTEN})
same => n,Macro(record,${CALLERID(num)})
same => n,Dial(IAX2/mikhailov/${EXTEN},${ARG1},${ARG2})
same => n,Return()

[blacklist]
exten => _X.,1,NoOp(===== CHECK BLACKLIST FOR NOM ${CALLERID(num)} =====)
same => n,Set(BLACKLIST=${DB(BLACKLIST/DEFAULT/${CALLERID(num)})})
same => n,GotoIf($["${BLACKLIST}"="1"]?check_exp_date:)
same => n,Set(BLACKLIST=${DB(BLACKLIST/${ARG1}/${CALLERID(num)})})
same => n,GotoIf($["${BLACKLIST}"="1"]?check_exp_date:no_black_list)

same => n(check_exp_date),NoOp(===== CHECK EXPIRE DATE BLACKLIST FOR ${CALLERID(num)} =====)
same => n,Set(BLACKLIST_EXP_DATE=${DB(BLACKLIST_EXP_DATE/DEFAULT/${CALLERID(num)})})
same => n,GotoIf($["${BLACKLIST_EXP_DATE}"!=""]?compare_exp_date:)
same => n,Set(BLACKLIST_EXP_DATE=${DB(BLACKLIST_EXP_DATE/${ARG1}/${CALLERID(num)})})
same => n,GotoIf($["${BLACKLIST_EXP_DATE}"!=""]?compare_exp_date:check_annoncement)

same => n(compare_exp_date),NoOp(===== COMPARE EXPIRE DATE BLACKLIST FOR ${CALLERID(num)} =====)
same => n,GotoIf($[${BLACKLIST_EXP_DATE} < ${STRFTIME(,,%G%m%d)}]?no_black_list:check_annoncement)

same => n(check_annoncement),NoOp(===== CHECK ANNONCEMENT BLACKLIST FOR ${CALLERID(num)} =====)
same => n,Set(BLACKLIST_ANNONCEMENT=${DB(BLACKLIST_ANNONCEMENT/${ARG1})})
same => n,GotoIf($["${BLACKLIST_ANNONCEMENT}"!=""]?block_with_annoncement:)
same => n,Set(BLACKLIST_ANNONCEMENT=${DB(BLACKLIST_ANNONCEMENT/DEFAULT)})
same => n,GotoIf($["${BLACKLIST_ANNONCEMENT}"!=""]?block_with_annoncement:block_without_annoncement)

same => n(block_with_annoncement),NoOp(===== BLOCK BLACKLIST FOR ${CALLERID(num)} WITH ANNONCEMENT =====)
same => n,Set(EXIST_BLACKLIST_ANNOCEMENT_FILE=${STAT(e,/var/lib/asterisk/roek_sounds/${BLACKLIST_ANNONCEMENT}.alaw)})
same => n,GotoIf($["${EXIST_BLACKLIST_ANNOCEMENT_FILE}"="1"]?:block_without_annoncement)
same => n,Background(/var/lib/asterisk/roek_sounds/${BLACKLIST_ANNONCEMENT})
same => n,Wait(2)
same => n,Hangup()

same => n(block_without_annoncement),NoOp(===== BLOCK BLACKLIST FOR ${CALLERID(num)} WITHOUT ANNONCEMENT =====)
same => n,Hangup()

same => n(no_black_list),NoOp(===== NO BLACKLIST FOR ${CALLERID(num)} =====)
same => n,Return()

[auto-fax]
; ${EXTEN} - from
; ${ARG1}  - to
exten => _X.,1,NoOp(===== TEST IS AUTO FAX FROM ${EXTEN} FOR NUM ${ARG1} =====)
same => n,GotoIf($["${EXTEN}"="5555"]?auto_fax:no_auto_fax)
same => n(auto_fax),NoOp(===== REDIRECT TO AUTO FAX =====)
same => n,Set(FAX_SIP_NUM=${ARG1})
same => n,Gosub(fax-rx,5555,1)
same => n,Return()
same => n(no_auto_fax),NoOp(===== NO REDIRECT TO AUTO FAX =====)
same => n,Return()

[macro-record]
exten => s,1,NoOp(===== CHECK RECORD for ${ARG1} =====)
exten => s,n,Set(RECORD=${DB(RECORD/${ARG1})})
exten => s,n,GotoIf($[${RECORD}]?record:no_record)

exten => s,n(record),MixMonitor(/home/asterisk/records/${STRFTIME(,,%G_%m_%d_%H:%M:%S)}_${MACRO_EXTEN}_${ARG1}.wav)
exten => s,n,Set(AUDIOHOOK_INHERIT(MixMonitor)=yes)
exten => s,n,MacroExit()

exten => s,n(no_record),Noop(===== RECORD DOES NOT NEED for ${ARG1} =====)
exten => s,n,MacroExit()

[call_forward]
exten => _X.,1,NoOp(===== CHECK CALL FORWARD for ${EXTEN} =====)
same => n,Set(FORWARD_NUM_UNCOND=${DB(CF_UNCOND/${EXTEN})})
same => n,Set(FORWARD_NUM_COND=${DB(CF_COND/${EXTEN})})
same => n,GotoIf($["${FORWARD_NUM_UNCOND}"=""]?:uncond)
same => n,GotoIf($["${FORWARD_NUM_COND}"=""]?:cond)
same => n,Goto(no_cf)

same => n(uncond),NoOp(IF($["${COND_FLAG}"!="1"]?===== CALL FORWARD UNCOND from ${CALLERID(num)} to ${FORWARD_NUM_UNCOND} =====))
same => n,Gosub(auto-fax,${FORWARD_NUM_UNCOND},1(${EXTEN}))
same => n,GoSub(to-office,${FORWARD_NUM_UNCOND},1(${CALL_DURATION},t,INFORWARD))
same => n,GoSub(to-sasovo,${FORWARD_NUM_UNCOND},1(${CALL_DURATION},t))
same => n,GoSub(to-kasimov,${FORWARD_NUM_UNCOND},1(${CALL_DURATION},t))
same => n,GoSub(to-mikhailov,${FORWARD_NUM_UNCOND},1(${CALL_DURATION},t))
same => n,GoSub(to-city,${FORWARD_NUM_UNCOND},1(${CALL_DURATION},))
same => n,GoSub(to-mg,${FORWARD_NUM_UNCOND},1(${CALL_DURATION},))
same => n,Hangup()

same => n(cond),NoOp()
same => n,GoSub(to-office,${EXTEN},1(10,t,INFORWARD))
same => n,GoSub(to-sasovo,${EXTEN},1(10,t))
same => n,GoSub(to-kasimov,${EXTEN},1(10,t))
same => n,GoSub(to-mikhailov,${EXTEN},1(10,t))
same => n,NoOp(===== CALL FORWARD COND from ${EXTEN} to ${FORWARD_NUM_UNCOND} =====)
same => n,Set(FORWARD_NUM_UNCOND=${FORWARD_NUM_COND})
same => n,Set(COND_FLAG=1)
same => n,Goto(uncond)

same => n(no_cf),NoOp(===== CALL FORWARD DOES NOT NEED for ${EXTEN} =====)
same => n,Return()

[star_codes]
exten => _X.,1,Return()

exten => _*11#,1,NoOp("===== REDIAL for ${CALLERID(name)} - ${CALLERID(num)} =====")
same => n,Set(REDIAL=${DB(REDIAL/${CALLERID(num)})})
same => n,Set(DOD_NUM=${IF($["${DB(DOD_E1/${CALLERID(num)})}"=""]?${DB(DOD_E1/global)}:${DB(DOD_E1/${CALLERID(num)})})})
same => n,Answer()
same => n,Wait(2)
same => n,Playback("ru/vm-num-i-have")
same => n,SayDigits(${REDIAL})
same => n,System(/var/lib/asterisk/scripts/autodial.py --src ${CALLERID(num)} --dst ${REDIAL} --dod ${DOD_NUM})
same => n,Wait(1)
same => n,Playback(ru/goodbye)
same => n,Hangup()

exten => _*71*X.,1,Set(DB(CF_COND/${CALLERID(num)})=${EXTEN:4})
exten => _*71*X.,n,Answer()
exten => _*71*X.,n,Wait(2)
exten => _*71*X.,n,SayDigits(${EXTEN:4})
exten => _*71*X.,n,Wait(1)
exten => _*71*X.,n,Playback(ru/goodbye)
exten => _*71*X.,n,Hangup()

exten => _*72*,1,Set(DB_DELETE(CF_COND/${CALLERID(num)})=${EXTEN:4})
exten => _*72*,n,Answer()
exten => _*72*,n,Wait(2)
exten => _*72*,n,Playback(ru/goodbye)
exten => _*72*,n,Hangup()

exten => _*73*,1,Set(REDIRNUM=${DB(CF_COND/${CALLERID(num)})=${EXTEN:4}})
exten => _*73*,n,Answer()
exten => _*73*,n,Wait(2)
exten => _*73*,n,SayDigits(${REDIRNUM})
exten => _*73*,n,Wait(1)
exten => _*73*,n,Playback(ru/goodbye)
exten => _*73*,n,Hangup()


exten => _*61*X.,1,Set(DB(CF_UNCOND/${CALLERID(num)})=${EXTEN:4})
exten => _*61*X.,n,Answer()
exten => _*61*X.,n,Wait(2)
exten => _*61*X.,n,SayDigits(${EXTEN:4})
exten => _*61*X.,n,Wait(1)
exten => _*61*X.,n,Playback(ru/goodbye)
exten => _*61*X.,n,Hangup()

exten => _*62*,1,Set(DB_DELETE(CF_UNCOND/${CALLERID(num)})=${EXTEN:4})
exten => _*62*,n,Answer()
exten => _*62*,n,Wait(2)
exten => _*62*,n,Playback(ru/goodbye)
exten => _*62*,n,Hangup()

exten => _*63*,1,Set(REDIRNUM=${DB(CF_UNCOND/${CALLERID(num)})=${EXTEN:4}})
exten => _*63*,n,Answer()
exten => _*63*,n,Wait(2)
exten => _*63*,n,SayDigits(${REDIRNUM})
exten => _*63*,n,Wait(1)
exten => _*63*,n,Playback(ru/goodbye)
exten => _*63*,n,Hangup()

[fax-rx]
exten => _5555,1,NoOP(===== Receive FAX from ${CALLERID(num)} =====)
exten => _5555,n,Answer()
exten => _5555,n,NoOp(===== FAX_SIP_NUM = ${FAX_SIP_NUM})
exten => _5555,n,Set(FAXOPT(headerinfo)=Received_by_${CALLERID(num)}_${STRFTIME(${EPOCH},,%Y-%m-%d_%H-%M)})
exten => _5555,n,Set(FAXOPT(localstationid)=Roek_PBX)
exten => _5555,n,Set(FAXOPT(maxrate)=9600)
exten => _5555,n,Set(FAXOPT(minrate)=4800)
exten => _5555,n,NoOp(FAXOPT(ecm) : ${FAXOPT(ecm)})
exten => _5555,n,NoOp(FAXOPT(headerinfo) : ${FAXOPT(headerinfo)})
exten => _5555,n,NoOp(FAXOPT(localstationid) : ${FAXOPT(localstationid)})
exten => _5555,n,NoOp(FAXOPT(maxrate) : ${FAXOPT(maxrate)})
exten => _5555,n,NoOp(FAXOPT(minrate) : ${FAXOPT(minrate)})
exten => _5555,n,ReceiveFax(/home/asterisk/fax/temp/${FAXOPT(headerinfo)}.tif)
exten => _5555,n,HangUp()

exten => h,1,NoOp(===== ${FAXSTATUS} ---${FAXERROR} ---${REMOTESTATIONID} =====)
exten => h,n,GotoIf($["${FAXSTATUS}"="SUCCESS"]?success_receive:error_receive)

exten => h,n(success_receive),NoOp(===== Receive FAX SUCCESS =====)
exten => h,n,System(/usr/bin/tiff2pdf "/home/asterisk/fax/temp/${FAXOPT(headerinfo)}.tif" -o /home/asterisk/fax/archive/receive/${FAXOPT(headerinfo)}.pdf)
exten => h,n,System(/bin/rm -f /home/asterisk/fax/temp/${FAXOPT(headerinfo)}.tif)
exten => h,n,Set(FAX_SIP_NUM_TO_EMAIL=${IF($["${FAX_SIP_NUM}"=""]?NO_NOMBER:${FAX_SIP_NUM})})
exten => h,n,Set(FAX_STATUS_TO_EMAIL=${IF($["${FAXSTATUS}"=""]?NO_STATUS:${FAXSTATUS})})
exten => h,n,Set(FAX_ERRORS_TO_EMAIL=${IF($["${FAXERROR}"=""]?NO_ERROR:${FAXERROR})})
exten => h,n,Set(FAX_ATTACHMENT_TO_EMAIL=${IF($["${STAT(e,/home/asterisk/fax/archive/receive/${FAXOPT(headerinfo)}.pdf)}"="1"]?"/home/asterisk/fax/archive/receive/${FAXOPT(headerinfo)}.pdf":"")})
exten => h,n,NoOp(===== FAX_SIP_NUM_TO_EMAIL = ${FAX_SIP_NUM_TO_EMAIL})
exten => h,n,NoOp(===== FAX_STATUS_TO_EMAIL = ${FAX_STATUS_TO_EMAIL})
exten => h,n,NoOp(===== FAX_ERRORS_TO_EMAIL = ${FAX_ERRORS_TO_EMAIL})
exten => h,n,NoOp(===== FAX_ATTACHMENT_TO_EMAIL = ${FAX_ATTACHMENT_TO_EMAIL})
exten => h,n,System(/home/asterisk/fax/sendEmail/sendFaxToEmail.sh "${FAX_SIP_NUM_TO_EMAIL}" "${FAX_STATUS_TO_EMAIL}" "${FAX_ERRORS_TO_EMAIL}" "${FAX_ATTACHMENT_TO_EMAIL}")
exten => h,n,Congestion()

exten => h,n(error_receive),NoOp(===== Receive FAX ERROR =====)
exten => h,n,System(/bin/rm -f /home/asterisk/fax/temp/${FAXOPT(headerinfo)}.tif)
exten => h,n,Set(FAX_SIP_NUM_TO_EMAIL=${IF($["${FAX_SIP_NUM}"=""]?NO_NOMBER:${FAX_SIP_NUM})})
exten => h,n,Set(FAX_STATUS_TO_EMAIL=${IF($["${FAXSTATUS}"=""]?NO_STATUS:${FAXSTATUS})})
exten => h,n,Set(FAX_ERRORS_TO_EMAIL=${IF($["${FAXERROR}"=""]?NO_ERROR:${FAXERROR})})
exten => h,n,Set(FAX_ATTACHMENT_TO_EMAIL=${IF($["${STAT(e,/home/asterisk/fax/archive/receive/${FAXOPT(headerinfo)}.pdf)}"="1"]?"/home/asterisk/fax/archive/receive/${FAXOPT(headerinfo)}.pdf":"")})
exten => h,n,NoOp(===== FAX_SIP_NUM_TO_EMAIL = ${FAX_SIP_NUM_TO_EMAIL})
exten => h,n,NoOp(===== FAX_STATUS_TO_EMAIL = ${FAX_STATUS_TO_EMAIL})
exten => h,n,NoOp(===== FAX_ERRORS_TO_EMAIL = ${FAX_ERRORS_TO_EMAIL})
exten => h,n,NoOp(===== FAX_ATTACHMENT_TO_EMAIL = ${FAX_ATTACHMENT_TO_EMAIL})
exten => h,n,System(/home/asterisk/fax/sendEmail/sendFaxToEmail.sh "${FAX_SIP_NUM_TO_EMAIL}" "${FAX_STATUS_TO_EMAIL}" "${FAX_ERRORS_TO_EMAIL}" "${FAX_ATTACHMENT_TO_EMAIL}")
exten => h,n,Congestion()

[fax-tx]
exten => _44XX,1,NoOp(===== Sending FAX to ${CALLERID(num)} =====)
exten => _44XX,n,Wait(1)
exten => _44XX,n,NoOp(===== FAX_SIP_NUM = ${FAX_SIP_NUM})
exten => _44XX,n,Set(FAXOPT(headerinfo)=Received_by_${CALLERID(num)}_${STRFTIME(${EPOCH},,%Y-%m-%d_%H-%M)})
exten => _44XX,n,Set(FAXOPT(localstationid)=Roek_PBX)
exten => _44XX,n,Set(FAXOPT(maxrate)=9600)
exten => _44XX,n,Set(FAXOPT(minrate)=4800)
exten => _44XX,n,NoOp(FAXOPT(headerinfo) : ${FAXOPT(headerinfo)})
exten => _44XX,n,NoOp(FAXOPT(localstationid) : ${FAXOPT(localstationid)})
exten => _44XX,n,NoOp(FAXOPT(maxrate) : ${FAXOPT(maxrate)})
exten => _44XX,n,NoOp(FAXOPT(minrate) : ${FAXOPT(minrate)})
exten => _44XX,n,Set(FAX_FILE_NAME=${EXTEN})
exten => _44XX,n,SendFAX(/home/asterisk/fax/for_send/${FAX_FILE_NAME}.tif)
exten => _44XX,n,HangUp()

exten => h,1,NoOp(===== ${FAXSTATUS} ---${FAXERROR} ---${REMOTESTATIONID} =====)
exten => h,n,GotoIf($["${FAXSTATUS}"="SUCCESS"]?success_send:error_send)

exten => h,n(success_send),NoOp(===== Send FAX SUCCESS =====)
exten => h,n,System(/bin/mv /home/asterisk/fax/for_send/${FAX_FILE_NAME}.tif /home/asterisk/fax/archive/send/${FAX_FILE_NAME}_${CALLERID(num)}_${STRFTIME(${EPOCH},,%Y-%m-%d_%H-%M)}.tif)
exten => h,n,Set(FAX_SIP_NUM_TO_EMAIL=${IF($["${FAX_SIP_NUM}"=""]?NO_NOMBER:${FAX_SIP_NUM})})
exten => h,n,Set(FAX_STATUS_TO_EMAIL=${IF($["${FAXSTATUS}"=""]?NO_STATUS:${FAXSTATUS})})
exten => h,n,Set(FAX_ERRORS_TO_EMAIL=${IF($["${FAXERROR}"=""]?NO_ERROR:${FAXERROR})})
exten => h,n,Set(FAX_ATTACHMENT_TO_EMAIL=${IF($["${STAT(e,/home/asterisk/fax/archive/send/${FAX_FILE_NAME}_${CALLERID(num)}_${STRFTIME(${EPOCH},,%Y-%m-%d_%H-%M)}.tif)}"="1"]?"/home/asterisk/fax/archive/send/${FAX_FILE_NAME}_${CALLERID(num)}_${STRFTIME(${EPOCH},,%Y-%m-%d_%H-%M)}.tif":"")})
exten => h,n,NoOp(===== FAX_SIP_NUM_TO_EMAIL = ${FAX_SIP_NUM_TO_EMAIL})
exten => h,n,NoOp(===== FAX_STATUS_TO_EMAIL = ${FAX_STATUS_TO_EMAIL})
exten => h,n,NoOp(===== FAX_ERRORS_TO_EMAIL = ${FAX_ERRORS_TO_EMAIL})
exten => h,n,NoOp(===== FAX_ATTACHMENT_TO_EMAIL = ${FAX_ATTACHMENT_TO_EMAIL})
exten => h,n,System(/home/asterisk/fax/sendEmail/sendFaxToEmail.sh "${FAX_SIP_NUM_TO_EMAIL}" "${FAX_STATUS_TO_EMAIL}" "${FAX_ERRORS_TO_EMAIL}" "${FAX_ATTACHMENT_TO_EMAIL}")
exten => h,n,Congestion()

exten => h,n(error_send),NoOp(===== Send FAX ERROR =====)
exten => h,n,Set(FAX_SIP_NUM_TO_EMAIL=${IF($["${FAX_SIP_NUM}"=""]?NO_NOMBER:${FAX_SIP_NUM})})
exten => h,n,Set(FAX_STATUS_TO_EMAIL=${IF($["${FAXSTATUS}"=""]?NO_STATUS:${FAXSTATUS})})
exten => h,n,Set(FAX_ERRORS_TO_EMAIL=${IF($["${FAXERROR}"=""]?NO_ERROR:${FAXERROR})})
exten => h,n,Set(FAX_ATTACHMENT_TO_EMAIL=${IF($["${STAT(e,/home/asterisk/fax/archive/send/${FAX_FILE_NAME}_${CALLERID(num)}_${STRFTIME(${EPOCH},,%Y-%m-%d_%H-%M)}.tif)}"="1"]?"/home/asterisk/fax/archive/send/${FAX_FILE_NAME}_${CALLERID(num)}_${STRFTIME(${EPOCH},,%Y-%m-%d_%H-%M)}.tif":"")})
exten => h,n,NoOp(===== FAX_SIP_NUM_TO_EMAIL = ${FAX_SIP_NUM_TO_EMAIL})
exten => h,n,NoOp(===== FAX_STATUS_TO_EMAIL = ${FAX_STATUS_TO_EMAIL})
exten => h,n,NoOp(===== FAX_ERRORS_TO_EMAIL = ${FAX_ERRORS_TO_EMAIL})
exten => h,n,NoOp(===== FAX_ATTACHMENT_TO_EMAIL = ${FAX_ATTACHMENT_TO_EMAIL})
exten => h,n,System(/home/asterisk/fax/sendEmail/sendFaxToEmail.sh "${FAX_SIP_NUM_TO_EMAIL}" "${FAX_STATUS_TO_EMAIL}" "${FAX_ERRORS_TO_EMAIL}" "${FAX_ATTACHMENT_TO_EMAIL}")
exten => h,n,Congestion()

[callback]
exten => _X.,1,NoOp("===== CALLBACK TO ${EXTEN} FROM ${CALLBACK_DST} =====")
;same => n,Playback("ru/vm-extension")
same => n,Playback("ru/followme/call-from")
same => n,Wait(1)
same => n,SayDigits(${DOD_NUM})
same => n,Dial(SIP/${EXTEN}, 60, U(introduce-callback, s, 1))
;same => n,Hangup()

[introduce-callback]
exten => s,1,NoOp(===== INTRODUCE =====)
same => n,Wait(1)
same => n,Playback("ru/transfer")
same => n,Wait(2)
same => n,Return()

#include /opt/astconfman/asterisk_etc/extensions.conf

